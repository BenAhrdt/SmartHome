blueprint:
  name: To IoBroker – Entity → MQTT
  description: >
    Sendet State-Änderungen markierter Home-Assistant-Entities
    strukturiert via MQTT an ioBroker.
  domain: automation

  input:
    topic_prefix:
      name: MQTT Topic Prefix
      description: z.B. lorawan_0, lorawan_1, ...
      default: lorawan_0
      selector:
        select:
          mode: dropdown
          options:
            - lorawan_0
            - lorawan_1
            - lorawan_2

    sync_label:
      name: Entity Label
      description: Label kann an Entity ODER Gerät hängen
      default: ToIob
      selector:
        text:

mode: queued
max: 10

trigger:
  - platform: event
    event_type: state_changed

condition:
  - condition: template
    value_template: >
      {% set eid = trigger.event.data.entity_id %}
      {% set ns = trigger.event.data.new_state %}
      {% set dev = device_id(eid) %}
      {{
        eid is not none
        and ns is not none
        and ns.state not in ['unknown','unavailable']
        and (
          eid in label_entities(input.sync_label)
          or (dev is not none and dev in label_devices(input.sync_label))
        )
      }}

action:
  - variables:
      # Blueprint-Input korrekt in Variable überführen
      topic_prefix: !input topic_prefix

      eid: "{{ trigger.event.data.entity_id }}"
      ns: "{{ trigger.event.data.new_state }}"
      dev: "{{ device_id(eid) }}"

  - action: mqtt.publish
    data:
      topic: >
        {{ topic_prefix }}/{{ topic_prefix }}/{{ topic_prefix }}_bridge_datatoiob/set
      retain: false
      payload: >
        {
          "entities": {
            "{{ eid }}": {{
              dict(
                ns.attributes
                | combine({
                    "entity_id": eid,
                    "unique_id": ns.attributes.unique_id | default(eid),
                    "friendly_name": ns.attributes.friendly_name | default(eid),
                    "state": ns.state,
                    "last_changed": ns.last_changed | string,
                    "last_updated": ns.last_updated | string,
                    "device_class": ns.attributes.device_class | default(None),
                    "state_class": ns.attributes.state_class | default(None),
                    "unit_of_measurement": ns.attributes.unit_of_measurement | default(None),
                    "device": {
                      "id": dev,
                      "name": device_attr(dev, 'name') | default('unknown'),
                      "manufacturer": device_attr(dev, 'manufacturer') | default('unknown'),
                      "model": device_attr(dev, 'model') | default('unknown')
                    }
                })
              ) | tojson
            }}
          }
        }
