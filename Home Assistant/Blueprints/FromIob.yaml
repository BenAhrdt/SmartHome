blueprint:
  name: From ioBroker – Entity → HA Control
  description: >
    Reagiert auf JSON-Steuerdaten aus einem ioBroker-LoRaWAN-Gerät
    (sensor.lorawan_X_datafromiob) und steuert Home-Assistant-Entities
    abhängig vom Domain-Typ.
  domain: automation

  input:
    lorawan_instance:
      name: LoRaWAN Instanz
      description: Wähle die ioBroker-LoRaWAN-Instanz
      default: lorawan_0
      selector:
        select:
          mode: dropdown
          options:
            - lorawan_0
            - lorawan_1
            - lorawan_2

mode: queued
max: 10

trigger:
  - platform: state
    entity_id:
      - sensor.lorawan_0_datafromiob
      - sensor.lorawan_1_datafromiob
      - sensor.lorawan_2_datafromiob

condition:
  - condition: template
    value_template: >
      {{ trigger.entity_id == 'sensor.' ~ input.lorawan_instance ~ '_datafromiob' }}

action:
  - variables:
      payload: "{{ trigger.to_state.state | from_json }}"
      entity_id: "{{ payload.keys() | list | first }}"
      value: "{{ payload[entity_id] }}"
      domain: "{{ entity_id.split('.')[0] }}"

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ domain in ['switch','light','input_boolean'] }}"
        sequence:
          - service: "{{ domain }}.turn_{{ 'on' if value in [true,'true','on','1',1] else 'off' }}"
            target:
              entity_id: "{{ entity_id }}"

      - conditions:
          - condition: template
            value_template: "{{ domain == 'input_number' }}"
        sequence:
          - service: input_number.set_value
            target:
              entity_id: "{{ entity_id }}"
            data:
              value: "{{ value }}"

      - conditions:
          - condition: template
            value_template: "{{ domain == 'input_select' }}"
        sequence:
          - service: input_select.select_option
            target:
              entity_id: "{{ entity_id }}"
            data:
              option: "{{ value }}"

      - conditions:
          - condition: template
            value_template: "{{ domain == 'cover' }}"
        sequence:
          - service: >
              {{ 'cover.open_cover' if value in [true,'open','on','1',1] else 'cover.close_cover' }}
            target:
              entity_id: "{{ entity_id }}"

      - conditions:
          - condition: template
            value_template: "{{ domain == 'lock' }}"
        sequence:
          - service: >
              {{ 'lock.lock' if value in [true,'lock','locked','on','1',1] else 'lock.unlock' }}
            target:
              entity_id: "{{ entity_id }}"

  - service: system_log.write
    data:
      level: warning
      message: "ioBroker command ignored: {{ trigger.to_state.state }}"
